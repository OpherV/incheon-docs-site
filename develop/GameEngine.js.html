<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GameEngine.js - Documentation</title>


    <link rel="shortcut icon" href="http://incheon.gg/favicon.ico">
    <link rel="icon" sizes="16x16 32x32 64x64" href="http://incheon.gg/favicon.ico">
    <link rel="icon" type="image/png" sizes="196x196" href="http://incheon.gg/favicon-192.png">
    <link rel="icon" type="image/png" sizes="160x160" href="http://incheon.gg/favicon-160.png">
    <link rel="icon" type="image/png" sizes="96x96" href="http://incheon.gg/favicon-96.png">
    <link rel="icon" type="image/png" sizes="64x64" href="http://incheon.gg/favicon-64.png">
    <link rel="icon" type="image/png" sizes="32x32" href="http://incheon.gg/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="http://incheon.gg/favicon-16.png">
        
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link href="https://file.myfontastic.com/DeXq9523CzrFERZkXSzP7D/icons.css" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.8.0/styles/atelier-sulphurpool-light.min.css">
</head>
<body>

    <input type="checkbox" id="nav-trigger" class="nav-trigger" />
    <label for="nav-trigger" class="navicon-button x">
      <div class="navicon"></div>
    </label>

    <label for="nav-trigger" class="overlay"></label>

    <nav>
        <h2 class="home"><a href="index.html">Incheon</a></h2><h2>Concepts</h2><ul class="tutorials"><li><a href="tutorial-prologue.html">Prologue</a></li><li><a href="tutorial-guide.html">Architecture of a Multiplayer Game</a><ul><li><a href="tutorial-guide_gameengine.html">Game Engine</a></li><li><a href="tutorial-guide_serverengine.html">Server Engine</a></li><li><a href="tutorial-guide_clientengine.html">Client Engine</a></li><li><a href="tutorial-guide_renderer.html">Renderer</a></li><li><a href="tutorial-guide_gameworld.html">Game World and Game Objects</a></li><li><a href="tutorial-guide_serialization.html">Serialization and Communication</a></li></ul></li><li><a href="tutorial-guide_synchronization_methods.html">Synchronization Methods</a><ul><li><a href="tutorial-guide_syncinterpolation.html">Interpolation</a></li><li><a href="tutorial-guide_syncextrapolation.html">Extrapolation</a></li></ul></li><li><a href="tutorial-tutorials.html">Tutorials</a><ul><li><a href="tutorial-MyFirstGame.html">My First Game: Pong</a></li><li><a href="tutorial-spaceships.html">Spaaace</a></li></ul></li><li><a href="tutorial-guide_tuningdebugging.html">Fine Tuning and Debugging</a></li><li><a href="tutorial-furtherreading.html">Further Reading</a></li></ul><h2>API Reference</h2><h3 class="classes">Classes</h3><ul><li><a href="ClientEngine.html">ClientEngine</a><ul class='methods'><li data-type='method'><a href="ClientEngine.html#connect">connect</a></li><li data-type='method'><a href="ClientEngine.html#sendInput">sendInput</a></li><li data-type='method'><a href="ClientEngine.html#start">start</a></li></ul></li><li><a href="DynamicObject.html">DynamicObject</a><ul class='methods'><li data-type='method'><a href="DynamicObject.html#init">init</a></li><li data-type='method'><a href="DynamicObject.html#toString">toString</a></li></ul></li><li><a href="GameEngine.html">GameEngine</a><ul class='methods'><li data-type='method'><a href="GameEngine.html#on">on</a></li><li data-type='method'><a href="GameEngine.html#once">once</a></li><li data-type='method'><a href="GameEngine.html#processInput">processInput</a></li><li data-type='method'><a href="GameEngine.html#removeListener">removeListener</a></li><li data-type='method'><a href="GameEngine.html#start">start</a></li></ul></li><li><a href="Renderer.html">Renderer</a><ul class='methods'><li data-type='method'><a href="Renderer.html#addObject">addObject</a></li><li data-type='method'><a href="Renderer.html#draw">draw</a></li><li data-type='method'><a href="Renderer.html#init">init</a></li><li data-type='method'><a href="Renderer.html#removeObject">removeObject</a></li></ul></li><li><a href="Serializer.html">Serializer</a><ul class='methods'><li data-type='method'><a href="Serializer.html#addCustomType">addCustomType</a></li><li data-type='method'><a href="Serializer.html#registerClass">registerClass</a></li></ul></li><li><a href="ServerEngine.html">ServerEngine</a></li></ul><h3 class="events">Events</h3><ul><li><a href="GameEngine_client.html#.event:postInput">postInput</a></li><li><a href="GameEngine_client.html#.event:postStep">postStep</a></li><li><a href="GameEngine_client.html#.event:preInput">preInput</a></li><li><a href="GameEngine_client.html#.event:preStep">preStep</a></li><li><a href="GameEngine_client.html#.event:syncReceived">syncReceived</a></li><li><a href="GameEngine.html#event:objectAdded">objectAdded</a></li><li><a href="GameEngine.html#event:objectDestroyed">objectDestroyed</a></li><li><a href="GameEngine.html#event:playerDisconnected">playerDisconnected</a></li><li><a href="GameEngine.html#event:playerJoined">playerJoined</a></li><li><a href="GameEngine.html#event:postStep">postStep</a></li><li><a href="GameEngine.html#event:preStep">preStep</a></li><li><a href="GameEngine.html#event:syncReceived">syncReceived</a></li><li><a href="GameEngine_server.html#.event:inputReceived">inputReceived</a></li><li><a href="GameEngine_server.html#.event:postStep">postStep</a></li><li><a href="GameEngine_server.html#.event:preStep">preStep</a></li></ul>
    </nav>

    <div id="main">
        
        <h1 class="page-title">GameEngine.js</h1>
        

        



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
const GameWorld = require('./GameWorld');
const Timer = require('./lib/Timer');
const EventEmitter = require('eventemitter3');
const Trace = require('./lib/Trace');

/**
 * The GameEngine contains the game logic.  Extend this class
 * to implement game mechanics.  The GameEngine derived
 * instance runs once on the server, where the final decisions
 * are always taken, and one instance will run on each client as well,
 * where the client emulates what it expects to be happening
 * on the server.
 *
 * The game engine's logic must listen to user inputs and
 * act on these inputs to change the game state.  For example,
 * the game engine listens to controller/keyboard inputs to infer
 * movement for the player/ship/first-person.  The game engine listens
 * to clicks, button-presses to infer firing, etc..
 *
 * Note that the game engine runs on both the server and on the
 * clients - but the server decisions always have the final say,
 * and therefore clients must resolve server updates which conflict
 * with client-side predictions.
 */
class GameEngine {

    /**
     * EVENTS
     */

    /**
     * Marks the beginning of a new game step
     *
     * @event GameEngine#preStep
     * @param {Number} stepNumber - the step number
     * @param {Boolean} isReenact - is this step a re-enactment
     */

    /**
     * Marks the end of a game step
     *
     * @event GameEngine#postStep
     * @param {Number} stepNumber - the step number
     * @param {Boolean} isReenact - is this step a re-enactment
     */

    /**
     * An object has been added to the world
     *
     * @event GameEngine#objectAdded
     * @param {Object} obj - the new object
     */

    /**
     * An object has been removed from the world
     *
     * @event GameEngine#objectDestroyed
     * @param {Object} obj - the object
     */

    /**
     * A player has joined
     *
     * @event GameEngine#playerJoined
     * @param {Object} playerDesc - player descriptor
     * @param {String} playerDesc.playerId - the player ID
     */

    /**
     * A player has left
     *
     * @event GameEngine#playerDisconnected
     * @param {Object} playerDesc - player descriptor
     * @param {String} playerDesc.playerId - the player ID
     */

    /**
     * A synchronization update arrived from the server
     *
     * @event GameEngine#syncReceived
     * @param {Object} sync - the synchronization object
     */

    /**
     * Marks the beginning of a game step on the client
     *
     * @event GameEngine#client.preStep
     */

    /**
     * Marks the end of a game step on the client
     *
     * @event GameEngine#client.postStep
     */

    /**
     * Client about to apply an input locally
     *
     * @event GameEngine#client.preInput
     * @param {Object} inputData - input descriptor
     */

    /**
     * Client finished applying an input locally
     *
     * @event GameEngine#client.postInput
     * @param {Object} inputData - input descriptor
     */

    /**
     * Client received a sync from the server
     *
     * @event GameEngine#client.syncReceived
     * @param {Object} sync - sync from the server
     * @param {Array} syncEvents - array of events in the sync
     * @param {Number} maxStepCount - highest step in the sync
     */

    /**
     * Marks the beginning of a game step on the server
     *
     * @event GameEngine#server.preStep
     * @param {Number} stepNumber - the step number
     */

    /**
     * Marks the end of a game step on the server
     *
     * @event GameEngine#server.postStep
     * @param {Number} stepNumber - the step number
     */

    /**
     * User input received on the server
     *
     * @event GameEngine#server.inputReceived
     * @param {Object} input - input descriptor
     * @param {Object} input.data - input descriptor
     * @param {Object} input.playerId - player that sent the input
     */

    /**
      * Create a game engine instance.  This needs to happen
      * once on the server, and once on each client.
      *
      * @param {Object} options - options object
      * @param {Number} options.traceLevel - the trace level from 0 to 5.  Lower value traces more.
      * @param {Number} options.delayInputCount - client side only.  Introduce an artificial delay on the client to better match the time it will occur on the server.  This value sets the number of steps the client will wait before applying the input locally
      */
    constructor(options) {

        // if no GameWorld is specified, use the default one
        this.options = Object.assign({
            GameWorld: GameWorld,
            traceLevel: Trace.TRACE_NONE
        }, options);

        // get the physics engine and initialize it
        if (this.options.physicsEngine) {
            this.physicsEngine = this.options.physicsEngine;
            this.physicsEngine.init({ gameEngine: this });
        }

        // set up event emitting and interface
        let eventEmitter = new EventEmitter();

        /**
         * Register a handler for an event
         *
         * @method on
         * @memberof GameEngine
         * @instance
         * @param {String} eventName - name of the event
         * @param {Function} eventHandler - handler function
         */
        this.on = eventEmitter.on;

        /**
         * Register a handler for an event, called just once (if at all)
         *
         * @method once
         * @memberof GameEngine
         * @instance
         * @param {String} eventName - name of the event
         * @param {Function} eventHandler - handler function
         */
        this.once = eventEmitter.once;

        /**
         * Remove a handler
         *
         * @method removeListener
         * @memberof GameEngine
         * @instance
         * @param {String} eventName - name of the event
         * @param {Function} eventHandler - handler function
         */
        this.removeListener = eventEmitter.removeListener;

        this.emit = eventEmitter.emit;

        // set up trace
        this.trace = new Trace({ traceLevel: this.options.traceLevel });
    }

    findLocalShadow(serverObj) {

        for (let localId of Object.keys(this.world.objects)) {
            let localObj = this.world.objects[localId];
            if (localObj.hasOwnProperty('inputId') &amp;&amp; localObj.inputId === serverObj.inputId)
                return localObj;
        }

        return null;
    }

    initWorld() {

        // TODO: with arrow functions, we no longer need that=this mechanism
        // remove the usage here and in all places in the code
        var that = this;

        this.world = new GameWorld();

        // on the client we have a different ID space
        if (this.options.clientIDSpace) {
            this.world.idCount = this.options.clientIDSpace;
        }

        /**
        * The worldSettings defines the game world constants, such
        * as width, height, depth, etc. such that all other classes
        * can reference these values.
        * @member {Object} worldSettings
        * @memberof GameEngine
        */
        this.worldSettings = {};

        this.timer = new Timer();
        this.timer.play();

        this.on("postStep", function() {
            that.timer.tick();
        });
    }

    /**
      * Start the game. This method runs on both server
      * and client. Extending the start method is useful
      * for setting up the game's worldSettings attribute,
      * and registering methods on the event handler.
      */
    start() {
        this.trace.info(`========== game engine started ==========`);
        this.initWorld();
    }

    step(isReenact) {

        // emit preStep event
        isReenact = Boolean(isReenact);
        let step = ++this.world.stepCount;
        let clientIDSpace = this.options.clientIDSpace;
        this.emit("preStep", { step, isReenact });

        // skip physics for shadow objects during re-enactment
        function objectFilter(o) {
            return !isReenact || o.id &lt; clientIDSpace;
        }

        // physics step
        if (this.physicsEngine)
            this.physicsEngine.step(objectFilter);

        // trace object positions after physics
        for (let objId of Object.keys(this.world.objects)) {
            this.trace.trace(`object[${objId}] after ${isReenact ? "reenact" : "step"} : ${this.world.objects[objId].toString()}`);
        }

        // emit postStep event
        this.emit("postStep", { step, isReenact });
    }

    addObjectToWorld(object) {
        this.world.objects[object.id] = object;

        this.emit("objectAdded", object);
        this.trace.info(`========== object added ${object.toString()} ==========`);
    }

    /**
     * Override this function to implement input handling.
     * This method will be called on the specific client where the
     * input was received, and will also be called on the server
     * when the input reaches the server.  The client does not call this
     * method directly, rather the client calls {@link ClientEngine#sendInput}
     * so that the input is sent to both server and client, and so that
     * the input is delayed artificially if so configured.
     *
     * The input is described by a short string, and is given an index.
     * The index is used internally to keep track of inputs which have already been applied
     * on the client during synchronization.  The input is also associated with
     * the ID of a player.
     *
     * @param {Object} inputMsg - input descriptor object
     * @param {String} inputMsg.input - describe the input (e.g. "up", "down", "fire")
     * @param {Number} inputMsg.messageIndex - input identifier
     * @param {String} playerId - the player number (as a string)
     */
    processInput(inputMsg, playerId) {
        // TODO - I don't think we need the playerId as an argument above.
        //    it could be a class member.
        this.trace.info(`game engine processing input[${inputMsg.messageIndex}] &lt;${inputMsg.input}> from playerId ${playerId}`);
    }

    removeObjectFromWorld(id) {
        let ob = this.world.objects[id];
        this.trace.info(`========== destroying object ${ob.toString()} ==========`);
        this.emit("objectDestroyed", ob);
        ob.destroy();
        delete this.world.objects[id];
    }

}

module.exports = GameEngine;
</code></pre>
        </article>
    </section>




    </div>

    <br class="clear">

    <footer>

    </footer>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-88335360-1', 'auto');
      ga('send', 'pageview');

    </script>
    <script src="https://use.typekit.net/lai1bbe.js"></script>
    <script>try{Typekit.load({ async: true });}catch(e){}</script>


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="scripts/linenumber.js"></script>
</body>
</html>
